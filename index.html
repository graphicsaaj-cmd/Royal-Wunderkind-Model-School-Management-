<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Royal Wunderkind Model School ‚Äì Result & Receipt</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
  --purple: #8a168a;
  --light-purple: #d38ad3;
  --border: #8a168a;
  --text: #222;
}
body {
  font-family: Arial, Helvetica, sans-serif;
  margin: 0;
  background: #f7f7f7;
  color: var(--text);
}
.container {
  max-width: 1200px;
  margin: 20px auto;
  background: #fff;
  padding: 20px;
  border: 2px solid var(--border);
  border-radius: 12px;
  overflow-x: auto;
}
h1, h2, h3, .section-title {
  text-align: center;
  margin: 6px 0;
}
.school-header {
  display: flex;
  align-items: center;
  gap: 15px;
  border-bottom: 4px solid var(--purple);
  padding-bottom: 10px;
  margin-bottom: 20px;
}
.school-logo {
  width: 80px;
  height: 80px;
  border: 1px dashed #999;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  overflow: hidden;
  flex-shrink: 0;
}
.school-logo img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}
.school-info {
  flex: 1;
  text-align: center;
}
.school-header h1 {
  color: var(--purple);
  font-size: 22px;
  margin: 0;
}
.school-header p {
  margin: 2px 0;
  font-size: 14px;
}
.contact-line {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 13px;
}
.contact-line i {
  font-size: 16px;
  width: 20px;
  text-align: center;
}
.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  justify-content: center;
}
.tabs button {
  flex: 1 1 100px;
  padding: 12px;
  border: none;
  background: var(--light-purple);
  color: #000;
  font-weight: bold;
  cursor: pointer;
  border-radius: 6px;
}
.tabs button.active {
  background: var(--purple);
  color: #fff;
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
  justify-content: center;
  align-items: center;
}
.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 10px;
  margin-bottom: 15px;
}
label {
  font-size: 13px;
  font-weight: bold;
  display: block;
}
input, select, textarea {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  border: 1px solid #999;
  border-radius: 4px;
  box-sizing: border-box;
}
textarea {
  min-height: 80px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
  font-size: 13px;
}
th, td {
  border: 1px solid var(--border);
  padding: 8px;
  text-align: center;
  word-wrap: break-word;
}
th {
  background: var(--purple);
  color: #fff;
  font-size: 12px;
}
td input, td select {
  border: none;
  text-align: center;
  width: 100%;
}
.section-title {
  background: var(--purple);
  color: #fff;
  padding: 8px;
  margin-top: 20px;
  font-weight: bold;
}
.two-col {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}
@media (min-width: 768px) {
  .two-col {
    grid-template-columns: 1fr 1fr;
  }
}
.total-box {
  text-align: right;
  font-weight: bold;
  font-size: 18px;
  margin-top: 10px;
}
.footer {
  display: grid;
  grid-template-columns: 1fr;
  margin-top: 30px;
  gap: 40px;
}
@media (min-width: 768px) {
  .footer {
    grid-template-columns: 1fr 1fr;
  }
}
.footer div {
  border-top: 1px solid #000;
  text-align: center;
  padding-top: 6px;
  font-size: 13px;
}
.signature-upload {
  width: 100%;
  height: 120px;
  border: 1px dashed #999;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  overflow: hidden;
  background: #f9f9f9;
  position: relative;
}
.signature-upload img {
  max-width: 90%;
  max-height: 100%;
  object-fit: contain;
}
.signature-delete {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(255,0,0,0.7);
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  cursor: pointer;
  font-size: 12px;
}
.table-wrapper {
  overflow-x: auto;
}
button.small-btn, button.print-btn, button.save-btn, button.load-btn {
  padding: 8px 16px;
  margin: 5px 0;
  font-size: 14px;
  cursor: pointer;
  background: var(--purple);
  color: white;
  border: none;
  border-radius: 6px;
}
button.print-btn {
  background: #28a745;
}
button.save-btn {
  background: #007bff;
}
button.load-btn {
  background: #6c757d;
}
.auto-save-notice {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #d4edda;
  color: #155724;
  padding: 10px 20px;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.5s;
  z-index: 1000;
}
.auto-save-notice.show {
  opacity: 1;
}
#settingsModal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 400px;
}
/* Print Styles */
@media print {
  @page { size: A4; margin: 10mm; }
  body, .container { background: white; margin: 0; padding: 12mm; }
  .tabs, .controls, .small-btn, .print-btn, #adminBtn, .auto-save-notice, .signature-delete, #settingsBtn {
    display: none !important;
  }
  .school-logo { width: 90px; height: 90px; }
  .info-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 10pt; }
  table { font-size: 9pt; }
  th, td { padding: 4px; }
  .section-title { padding: 4px; font-size: 10pt; }
  .two-col, .footer { grid-template-columns: 1fr 1fr; }
  .signature-upload { height: 60px; }
  input, select, textarea { border: none !important; background: transparent !important; font-size: 10pt !important; }
}
/* Mobile */
@media (max-width: 767px) {
  .school-header { flex-direction: column; text-align: center; }
  .controls { flex-direction: column; }
  button { width: 100%; }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="container">
  <!-- Settings Button -->
  <div style="text-align:right; margin-bottom:10px;">
    <button id="settingsBtn" onclick="openSettings()">‚öôÔ∏è Settings</button>
  </div>

  <!-- School Header -->
  <div class="school-header">
    <div class="school-logo" onclick="document.getElementById('logoInput').click()">Upload Logo</div>
    <input type="file" id="logoInput" style="display:none" accept="image/*" onchange="previewLogo(event)">
    <div class="school-info">
      <h1 contenteditable="true" id="schoolName">ROYAL WUNDERKIND MODEL SCHOOL</h1>
      <p contenteditable="true" id="schoolMotto">Partnering with Christ for a better world</p>
      <div class="contact-line"><i class="fas fa-map-marker-alt"></i> <span contenteditable="true" id="schoolAddress">Opposite Block 8, Plot 12, Mal. Abdulrahman A, Aderinoye Street</span></div>
      <div class="contact-line"><i class="fas fa-phone"></i> <span contenteditable="true" id="schoolPhone">+2348022738352</span></div>
      <div class="contact-line"><i class="fas fa-envelope"></i> <span contenteditable="true" id="schoolEmail">info@royalwunderkind.edu.ng</span></div>
      <div class="contact-line"><i class="fas fa-globe"></i> <span contenteditable="true" id="schoolWebsite">www.royalwunderkind.edu.ng</span></div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="active" onclick="showTab(event,'result')">Student Result</button>
    <button onclick="showTab(event,'receipt')">School Fees Receipt</button>
  </div>

  <!-- RESULT TAB -->
  <div id="result" class="tab-content active">
    <div class="controls">
      <input type="text" id="studentID" placeholder="Student ID (e.g. RW001)" style="width:200px;">
      <button onclick="saveStudentResult()" class="save-btn">üíæ Save & New</button>
      <button onclick="loadStudentResult()" class="load-btn">üìÇ Load Result</button>
      <select id="termSelect" style="padding:8px;">
        <option>1st Term</option><option>2nd Term</option><option>3rd Term</option>
      </select>
      <button onclick="window.print()" class="print-btn">üñ®Ô∏è Print Result</button>
    </div>
    <div class="info-grid">
      <div><label>Name<input id="resultName"></label></div>
      <div><label>Admission No<input id="resultAdmNo"></label></div>
      <div><label>Class<input id="resultClass"></label></div>
      <div><label>No. in Class<input id="resultNoInClass"></label></div>
      <div><label>Times Present<input id="resultPresent"></label></div>
      <div><label>Times Absent<input id="resultAbsent"></label></div>
    </div>
    <div class="table-wrapper">
      <table id="resultTable">
        <thead>
          <tr>
            <th>Subject</th>
            <th>CA1 (15)</th>
            <th>CA2 (15)</th>
            <th>HW (10)</th>
            <th>Exam (60)</th>
            <th>Total</th>
            <th>Grade</th>
            <th>Remark</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr style="font-weight:bold; background:#f0e6f0;">
            <td>Class Average</td>
            <td id="avgCA1">-</td>
            <td id="avgCA2">-</td>
            <td id="avgHW">-</td>
            <td id="avgExam">-</td>
            <td id="avgTotal">-</td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
      <button onclick="addSubject()" class="small-btn">Add Subject</button>
    </div>
    <div class="two-col">
      <div>
        <div class="section-title">Psychomotor Skills</div>
        <table>
          <tr><td>Handling of Tools</td><td><input id="psycho1"></td></tr>
          <tr><td>Verbal Fluency</td><td><input id="psycho2"></td></tr>
        </table>
      </div>
      <div>
        <div class="section-title">Affective Skills</div>
        <table>
          <tr><td>Cooperation</td><td><input id="affect1"></td></tr>
          <tr><td>Punctuality</td><td><input id="affect2"></td></tr>
          <tr><td>Reading</td><td><input id="affect3"></td></tr>
          <tr><td>Clean & Orderly</td><td><input id="affect4"></td></tr>
        </table>
      </div>
    </div>
    <div class="section-title">Teacher's Comment</div>
    <textarea id="teacherComment"></textarea>
    <div class="footer">
      <div>
        <strong>Class Teacher's Signature</strong>
        <div class="signature-upload" onclick="document.getElementById('classSigInput').click()">
          Click to upload
          <button class="signature-delete" onclick="deleteSignature(event, 'sigClass')">√ó</button>
        </div>
        <input type="file" id="classSigInput" style="display:none" accept="image/*" onchange="previewSignature(event, 'sigClass')">
      </div>
      <div>
        <strong>Head Teacher's Signature</strong>
        <div class="signature-upload" onclick="document.getElementById('headSigInput').click()">
          Click to upload
          <button class="signature-delete" onclick="deleteSignature(event, 'sigHead')">√ó</button>
        </div>
        <input type="file" id="headSigInput" style="display:none" accept="image/*" onchange="previewSignature(event, 'sigHead')">
      </div>
    </div>
  </div>

  <!-- RECEIPT TAB -->
  <div id="receipt" class="tab-content">
    <div class="controls">
      <input type="text" id="receiptID" placeholder="Receipt ID (e.g. REC001)" style="width:200px;">
      <button onclick="saveReceipt()" class="save-btn">üíæ Save & New</button>
      <button onclick="loadReceipt()" class="load-btn">üìÇ Load Receipt</button>
      <button onclick="window.print()" class="print-btn">üñ®Ô∏è Print Receipt</button>
      <button onclick="exportReceipt()" class="small-btn">Export Excel</button>
      <button onclick="requestAdminAccess()" class="small-btn" id="adminBtn">Admin Mode</button>
    </div>
    <div class="info-grid">
      <div><label>Student Name<input id="receiptName" disabled></label></div>
      <div><label>Class<input id="receiptClass" disabled></label></div>
      <div><label>Term<select id="receiptTerm" disabled><option>1st Term</option><option>2nd Term</option><option>3rd Term</option></select></label></div>
      <div><label>Session<input id="receiptSession" disabled></label></div>
      <div><label>Date<input type="date" id="receiptDate" disabled></label></div>
    </div>
    <div class="table-wrapper">
      <table id="receiptTable">
        <thead>
          <tr>
            <th>Description</th>
            <th>Amount (‚Ç¶)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button onclick="addReceiptRow()" class="small-btn" id="addEntryBtn" disabled>Add Entry</button>
    <div class="total-box">TOTAL: ‚Ç¶ <input id="totalReceipt" readonly style="width:150px; text-align:right; font-weight:bold;"></div>
    <div class="footer">
      <div>
        <strong>Finance Officer</strong>
        <div class="signature-upload" onclick="document.getElementById('financeInput').click()">
          Click to upload
          <button class="signature-delete" onclick="deleteSignature(event, 'sigFinance')">√ó</button>
        </div>
        <input type="file" id="financeInput" style="display:none" accept="image/*" onchange="previewSignature(event, 'sigFinance')" disabled>
      </div>
      <div>
        <strong>School Stamp</strong>
        <div class="signature-upload" onclick="document.getElementById('stampInput').click()">
          Click to upload
          <button class="signature-delete" onclick="deleteSignature(event, 'sigStamp')">√ó</button>
        </div>
        <input type="file" id="stampInput" style="display:none" accept="image/*" onchange="previewSignature(event, 'sigStamp')" disabled>
      </div>
    </div>
  </div>
</div>

<!-- Auto-save Notice -->
<div id="autoSaveNotice" class="auto-save-notice">‚úì Auto-saved</div>

<!-- Settings Modal -->
<div id="settingsModal">
  <div class="modal-content">
    <h3>GitHub Settings</h3>
    <p>To save/load/auto-save results & receipts from anywhere, enter a GitHub Personal Access Token (with <strong>gist</strong> scope):</p>
    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxx" style="width:100%; padding:8px;">
    <div style="margin-top:10px;">
      <button onclick="saveGitHubToken()" style="background:#28a745;">Save Token</button>
      <button onclick="closeSettings()" style="background:#dc3545; margin-left:10px;">Cancel</button>
    </div>
    <p style="font-size:12px; margin-top:15px;">
      <a href="https://github.com/settings/tokens/new" target="_blank">Create token here</a> ‚Üí select "gist" scope only.
    </p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// GitHub & Storage
const GIST_ID_RESULTS = 'results_storage';
const GIST_ID_RECEIPTS = 'receipts_storage';
let githubToken = localStorage.getItem('githubToken') || '';

// Auto-save variables
let autoSaveInterval = null;
const AUTO_SAVE_DELAY = 30000; // 30 seconds

// Settings modal
function openSettings() {
  document.getElementById('githubToken').value = githubToken ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
  document.getElementById('settingsModal').style.display = 'flex';
}
function closeSettings() {
  document.getElementById('settingsModal').style.display = 'none';
}
function saveGitHubToken() {
  const token = document.getElementById('githubToken').value.trim();
  if (token && token !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
    githubToken = token;
    localStorage.setItem('githubToken', token);
    alert('GitHub token saved!');
  }
  closeSettings();
  startAutoSaveIfNeeded();
}

// Gist helpers (same as before)
async function getGist(id) {
  if (!githubToken) return null;
  const res = await fetch(`https://api.github.com/gists/${id}`, {
    headers: { Authorization: `token ${githubToken}` }
  });
  if (res.status === 404) return null;
  if (!res.ok) { console.error('Gist error:', await res.text()); return null; }
  return await res.json();
}
async function createOrUpdateGist(id, description, files) {
  if (!githubToken) return null;
  const existing = await getGist(id);
  const method = existing ? 'PATCH' : 'POST';
  const url = existing ? `https://api.github.com/gists/${id}` : 'https://api.github.com/gists';
  const res = await fetch(url, {
    method,
    headers: { Authorization: `token ${githubToken}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ description, public: false, files, ...(existing ? {gist_id: id} : {}) })
  });
  if (!res.ok) { console.error('Save error:', await res.text()); return null; }
  return await res.json();
}
async function loadAllResults() {
  const gist = await getGist(GIST_ID_RESULTS);
  return gist && gist.files['index.json'] ? JSON.parse(gist.files['index.json'].content) : {};
}
async function loadAllReceipts() {
  const gist = await getGist(GIST_ID_RECEIPTS);
  return gist && gist.files['index.json'] ? JSON.parse(gist.files['index.json'].content) : {};
}
async function saveToGist(collectionId, indexKey, data) {
  const index = await (collectionId === GIST_ID_RESULTS ? loadAllResults() : loadAllReceipts());
  index[indexKey] = data;
  await createOrUpdateGist(collectionId, 'School results/receipts storage', {'index.json': {content: JSON.stringify(index)}});
}

// Auto-save functions
function showAutoSaveNotice() {
  const notice = document.getElementById('autoSaveNotice');
  notice.classList.add('show');
  setTimeout(() => notice.classList.remove('show'), 2000);
}
async function autoSaveActiveTab() {
  const activeTab = document.querySelector('.tab-content.active').id;
  if (activeTab === 'result') {
    const id = document.getElementById('studentID').value.trim();
    if (id && document.getElementById('resultName').value.trim()) {
      const data = getCurrentResultData();
      await saveToGist(GIST_ID_RESULTS, id, data);
      showAutoSaveNotice();
    }
  } else if (activeTab === 'receipt') {
    const id = document.getElementById('receiptID').value.trim();
    if (id && document.getElementById('receiptName').value.trim()) {
      const data = getCurrentReceiptData();
      await saveToGist(GIST_ID_RECEIPTS, id, data);
      showAutoSaveNotice();
    }
  }
}
function startAutoSaveIfNeeded() {
  if (autoSaveInterval) clearInterval(autoSaveInterval);
  if (githubToken) {
    autoSaveInterval = setInterval(autoSaveActiveTab, AUTO_SAVE_DELAY);
  }
}
function stopAutoSave() {
  if (autoSaveInterval) {
    clearInterval(autoSaveInterval);
    autoSaveInterval = null;
  }
}

// Manual save functions (unchanged, but now also restart auto-save)
async function saveStudentResult() {
  const id = document.getElementById('studentID').value.trim();
  if (!id) { alert("Please enter a Student ID"); return; }
  const data = getCurrentResultData();
  await saveToGist(GIST_ID_RESULTS, id, data);
  alert(`Result saved for ${id}`);
  showAutoSaveNotice();
  document.getElementById('studentID').value = '';
  clearResultForm();
}
async function saveReceipt() {
  const id = document.getElementById('receiptID').value.trim();
  if (!id) { alert("Please enter a Receipt ID"); return; }
  const data = getCurrentReceiptData();
  await saveToGist(GIST_ID_RECEIPTS, id, data);
  alert(`Receipt saved as ${id}`);
  showAutoSaveNotice();
  document.getElementById('receiptID').value = '';
  clearReceiptForm();
}

// Rest of your functions remain the same (load, images, calculations, etc.)
// ... [All previous functions: loadStudentResult, loadReceipt, getCurrentResultData, etc. unchanged]

// Tab switching ‚Äì restart auto-save on tab change
function showTab(event, id) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.currentTarget.classList.add('active');
  if (id === 'result') calculateClassAverages();
  startAutoSaveIfNeeded(); // ensure auto-save runs on active tab
}

// Initialize
loadImages();
loadSchoolHeader();
addSubjectRow();
addReceiptRowInternal('', '0');
calculateGrades();
updateTotal();

if (githubToken) {
  startAutoSaveIfNeeded();
  // Optional: alert('Auto-save enabled!');
} else {
  openSettings(); // prompt first time
}
</script>
</body>
</html>
