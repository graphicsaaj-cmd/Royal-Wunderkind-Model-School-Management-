<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// GitHub & Storage
const GIST_ID_RESULTS = 'results_storage';
const GIST_ID_RECEIPTS = 'receipts_storage';
let githubToken = localStorage.getItem('githubToken') || '';

// Auto-save variables
let autoSaveInterval = null;
const AUTO_SAVE_DELAY = 30000; // 30 seconds

// Settings modal
function openSettings() {
  document.getElementById('githubToken').value = githubToken ? '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' : '';
  document.getElementById('settingsModal').style.display = 'flex';
}
function closeSettings() {
  document.getElementById('settingsModal').style.display = 'none';
}
function saveGitHubToken() {
  const token = document.getElementById('githubToken').value.trim();
  if (token && token !== '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') {
    githubToken = token;
    localStorage.setItem('githubToken', token);
    alert('GitHub token saved! Auto-save enabled.');
    startAutoSaveIfNeeded();
  } else if (token === '') {
    githubToken = '';
    localStorage.removeItem('githubToken');
    stopAutoSave();
    alert('GitHub token removed.');
  }
  closeSettings();
}

// === FIXED GIST FUNCTIONS ===
async function getGist(id) {
  if (!githubToken) return null;
  const res = await fetch(`https://api.github.com/gists/${id}`, {
    headers: { Authorization: `token ${githubToken}` }
  });
  if (res.status === 404) return null;
  if (!res.ok) {
    console.error('Gist fetch error:', await res.text());
    return null;
  }
  return await res.json();
}

async function createOrUpdateGist(gistId, description, files) {
  if (!githubToken) return null;

  const existing = await getGist(gistId);
  const isUpdate = !!existing;

  const payload = {
    description,
    public: false,
    files
  };

  if (isUpdate) {
    payload.gist_id = gistId; // Required for PATCH
  }

  const url = isUpdate
    ? `https://api.github.com/gists/${gistId}`
    : 'https://api.github.com/gists';

  const res = await fetch(url, {
    method: isUpdate ? 'PATCH' : 'POST',
    headers: {
      Authorization: `token ${githubToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const errorText = await res.text();
    console.error('Gist save error:', errorText);
    alert('Failed to save to GitHub. Check console or token permissions.');
    return null;
  }
  return await res.json();
}

async function loadAllResults() {
  const gist = await getGist(GIST_ID_RESULTS);
  return gist && gist.files['index.json']
    ? JSON.parse(gist.files['index.json'].content)
    : {};
}

async function loadAllReceipts() {
  const gist = await getGist(GIST_ID_RECEIPTS);
  return gist && gist.files['index.json']
    ? JSON.parse(gist.files['index.json'].content)
    : {};
}

async function saveToGist(collectionId, indexKey, data) {
  if (!githubToken) return;
  const index = await (collectionId === GIST_ID_RESULTS ? loadAllResults() : loadAllReceipts());
  index[indexKey] = data;
  await createOrUpdateGist(
    collectionId,
    'School results/receipts storage',
    { 'index.json': { content: JSON.stringify(index) } }
  );
}

// Auto-save functions
function showAutoSaveNotice() {
  const notice = document.getElementById('autoSaveNotice');
  notice.classList.add('show');
  setTimeout(() => notice.classList.remove('show'), 2000);
}

async function autoSaveActiveTab() {
  if (!githubToken) return;

  const activeTab = document.querySelector('.tab-content.active').id;
  if (activeTab === 'result') {
    const id = document.getElementById('studentID').value.trim();
    if (id && document.getElementById('resultName').value.trim()) {
      const data = getCurrentResultData();
      await saveToGist(GIST_ID_RESULTS, id, data);
      showAutoSaveNotice();
    }
  } else if (activeTab === 'receipt') {
    const id = document.getElementById('receiptID').value.trim();
    if (id && document.getElementById('receiptName').value.trim()) {
      const data = getCurrentReceiptData();
      await saveToGist(GIST_ID_RECEIPTS, id, data);
      showAutoSaveNotice();
    }
  }
}

function startAutoSaveIfNeeded() {
  stopAutoSave(); // Clear any existing
  if (githubToken) {
    autoSaveInterval = setInterval(autoSaveActiveTab, AUTO_SAVE_DELAY);
  }
}

function stopAutoSave() {
  if (autoSaveInterval) {
    clearInterval(autoSaveInterval);
    autoSaveInterval = null;
  }
}

// Manual saves (with notice)
async function saveStudentResult() {
  const id = document.getElementById('studentID').value.trim();
  if (!id) { alert("Please enter a Student ID"); return; }
  const data = getCurrentResultData();
  await saveToGist(GIST_ID_RESULTS, id, data);
  alert(`Result saved for ${id}`);
  showAutoSaveNotice();
  document.getElementById('studentID').value = '';
  clearResultForm();
}

async function saveReceipt() {
  const id = document.getElementById('receiptID').value.trim();
  if (!id) { alert("Please enter a Receipt ID"); return; }
  const data = getCurrentReceiptData();
  await saveToGist(GIST_ID_RECEIPTS, id, data);
  alert(`Receipt saved as ${id}`);
  showAutoSaveNotice();
  document.getElementById('receiptID').value = '';
  clearReceiptForm();
}

// Load functions
async function loadStudentResult() {
  const id = document.getElementById('studentID').value.trim();
  if (!id) { alert("Please enter a Student ID"); return; }
  const all = await loadAllResults();
  const data = all[id];
  if (!data) { alert(`No result found for ${id}`); return; }
  loadResultFromData(data);
  await calculateClassAverages();
}

async function loadReceipt() {
  const id = document.getElementById('receiptID').value.trim();
  if (!id) { alert("Please enter a Receipt ID"); return; }
  const all = await loadAllReceipts();
  const data = all[id];
  if (!data) { alert(`No receipt found for ${id}`); return; }
  document.getElementById('receiptName').value = data.name || '';
  document.getElementById('receiptClass').value = data.class || '';
  document.getElementById('receiptTerm').value = data.term || '1st Term';
  document.getElementById('receiptSession').value = data.session || '';
  document.getElementById('receiptDate').value = data.date || '';
  const tbody = document.querySelector('#receiptTable tbody');
  tbody.innerHTML = '';
  (data.items || []).forEach(item => addReceiptRowInternal(item.desc, item.amt));
  updateTotal();
}

// === CLASS AVERAGES FIXED ===
async function calculateClassAverages() {
  const currentClass = document.getElementById('resultClass').value.trim();
  const currentTerm = document.getElementById('termSelect').value;
  if (!currentClass || !currentTerm) {
    clearAverages();
    return;
  }

  const allResults = await loadAllResults();
  const relevant = Object.values(allResults).filter(
    r => r.class === currentClass && r.term === currentTerm && r.subjects
  );

  if (relevant.length === 0) {
    clearAverages();
    return;
  }

  // Reset averages
  document.getElementById('avgCA1').innerText = '-';
  document.getElementById('avgCA2').innerText = '-';
  document.getElementById('avgHW').innerText = '-';
  document.getElementById('avgExam').innerText = '-';
  document.getElementById('avgTotal').innerText = '-';

  // Collect all scores per column
  const totals = { ca1: [], ca2: [], hw: [], exam: [], total: [] };

  relevant.forEach(result => {
    result.subjects.forEach(sub => {
      const c1 = Number(sub.ca1) || 0;
      const c2 = Number(sub.ca2) || 0;
      const h = Number(sub.hw) || 0;
      const e = Number(sub.exam) || 0;
      const t = c1 + c2 + h + e;
      totals.ca1.push(c1);
      totals.ca2.push(c2);
      totals.hw.push(h);
      totals.exam.push(e);
      totals.total.push(t);
    });
  });

  const avg = arr => arr.length ? (arr.reduce((a,b) => a+b, 0) / arr.length).toFixed(1) : '-';

  document.getElementById('avgCA1').innerText = avg(totals.ca1);
  document.getElementById('avgCA2').innerText = avg(totals.ca2);
  document.getElementById('avgHW').innerText = avg(totals.hw);
  document.getElementById('avgExam').innerText = avg(totals.exam);
  document.getElementById('avgTotal').innerText = avg(totals.total);
}

function clearAverages() {
  document.getElementById('avgCA1').innerText = '-';
  document.getElementById('avgCA2').innerText = '-';
  document.getElementById('avgHW').innerText = '-';
  document.getElementById('avgExam').innerText = '-';
  document.getElementById('avgTotal').innerText = '-';
}

// === REST OF YOUR FUNCTIONS (unchanged) ===
// previewSignature, deleteSignature, loadImages, saveSchoolHeader, loadSchoolHeader,
// getCurrentResultData, getCurrentReceiptData, loadResultFromData,
// addSubjectRow, addSubject, removeSubject, calculateGrades, getGrade, getRemark,
// addReceiptRowInternal, addReceiptRow, removeReceiptRow, updateTotal, exportReceipt,
// admin mode functions, previewLogo, showTab, etc.

// Tab switching
function showTab(event, id) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.currentTarget.classList.add('active');
  if (id === 'result') calculateClassAverages();
}

// Initialize
loadImages();
loadSchoolHeader();
addSubjectRow();
addReceiptRowInternal('', '0');
calculateGrades();
updateTotal();

if (githubToken) {
  startAutoSaveIfNeeded();
} else {
  setTimeout(openSettings, 1000); // Gentle reminder
}
</script>
