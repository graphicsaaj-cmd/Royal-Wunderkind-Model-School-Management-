<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Royal Wunderkind Model School ‚Äì Result & Receipt</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
  --purple: #8a168a;
  --light-purple: #d38ad3;
  --border: #8a168a;
  --text: #222;
}
body {
  font-family: Arial, Helvetica, sans-serif;
  margin: 0;
  background: #f7f7f7;
  color: var(--text);
}
.container {
  max-width: 1200px;
  margin: 20px auto;
  background: #fff;
  padding: 20px;
  border: 2px solid var(--border);
  border-radius: 12px;
  overflow-x: auto;
}
h1, h2, h3, .section-title {
  text-align: center;
  margin: 6px 0;
}
.school-header {
  display: flex;
  align-items: center;
  gap: 15px;
  border-bottom: 4px solid var(--purple);
  padding-bottom: 10px;
  margin-bottom: 20px;
}
.school-logo {
  width: 80px;
  height: 80px;
  border: 1px dashed #999;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  overflow: hidden;
  flex-shrink: 0;
}
.school-logo img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}
.school-info {
  flex: 1;
  text-align: center;
}
.school-header h1 {
  color: var(--purple);
  font-size: 22px;
  margin: 0;
}
.school-header p {
  margin: 2px 0;
  font-size: 14px;
}
.contact-line {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 13px;
}
.contact-line i {
  font-size: 16px;
  width: 20px;
  text-align: center;
}
.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  justify-content: center;
}
.tabs button {
  flex: 1 1 100px;
  padding: 12px;
  border: none;
  background: var(--light-purple);
  color: #000;
  font-weight: bold;
  cursor: pointer;
  border-radius: 6px;
}
.tabs button.active {
  background: var(--purple);
  color: #fff;
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
  justify-content: center;
  align-items: center;
}
.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 10px;
  margin-bottom: 15px;
}
label {
  font-size: 13px;
  font-weight: bold;
  display: block;
}
input, select, textarea {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  border: 1px solid #999;
  border-radius: 4px;
  box-sizing: border-box;
}
textarea {
  min-height: 80px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
  font-size: 13px;
}
th, td {
  border: 1px solid var(--border);
  padding: 8px;
  text-align: center;
  word-wrap: break-word;
}
th {
  background: var(--purple);
  color: #fff;
  font-size: 12px;
}
td input, td select {
  border: none;
  text-align: center;
  width: 100%;
}
.section-title {
  background: var(--purple);
  color: #fff;
  padding: 8px;
  margin-top: 20px;
  font-weight: bold;
}
.two-col {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}
@media (min-width: 768px) {
  .two-col {
    grid-template-columns: 1fr 1fr;
  }
}
.total-box {
  text-align: right;
  font-weight: bold;
  font-size: 18px;
  margin-top: 10px;
}
.footer {
  display: grid;
  grid-template-columns: 1fr;
  margin-top: 30px;
  gap: 40px;
}
@media (min-width: 768px) {
  .footer {
    grid-template-columns: 1fr 1fr;
  }
}
.footer div {
  border-top: 1px solid #000;
  text-align: center;
  padding-top: 6px;
  font-size: 13px;
}
.signature-upload {
  width: 100%;
  height: 120px;
  border: 1px dashed #999;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  overflow: hidden;
  background: #f9f9f9;
  position: relative;
}
.signature-upload img {
  max-width: 90%;
  max-height: 100%;
  object-fit: contain;
}
.signature-delete {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(255,0,0,0.7);
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  cursor: pointer;
  font-size: 12px;
}
.table-wrapper {
  overflow-x: auto;
}
button.small-btn, button.print-btn, button.save-btn, button.load-btn {
  padding: 8px 16px;
  margin: 5px 0;
  font-size: 14px;
  cursor: pointer;
  background: var(--purple);
  color: white;
  border: none;
  border-radius: 6px;
}
button.print-btn {
  background: #28a745;
}
button.save-btn {
  background: #007bff;
}
button.load-btn {
  background: #6c757d;
}
.auto-save-notice {
  text-align: center;
  font-size: 12px;
  color: green;
  margin: 10px 0;
}
#settingsModal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 400px;
}
/* Print Styles */
@media print {
  @page { size: A4; margin: 10mm; }
  body, .container { background: white; margin: 0; padding: 12mm; }
  .tabs, .controls, .small-btn, .print-btn, #adminBtn, .auto-save-notice, .signature-delete, #settingsBtn {
    display: none !important;
  }
  .school-logo { width: 90px; height: 90px; }
  .info-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 10pt; }
  table { font-size: 9pt; }
  th, td { padding: 4px; }
  .section-title { padding: 4px; font-size: 10pt; }
  .two-col, .footer { grid-template-columns: 1fr 1fr; }
  .signature-upload { height: 60px; }
  input, select, textarea { border: none !important; background: transparent !important; font-size: 10pt !important; }
}
/* Mobile */
@media (max-width: 767px) {
  .school-header { flex-direction: column; text-align: center; }
  .controls { flex-direction: column; }
  button { width: 100%; }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="container">
  <!-- Settings Button -->
  <div style="text-align:right; margin-bottom:10px;">
    <button id="settingsBtn" onclick="openSettings()">‚öôÔ∏è Settings</button>
  </div>

  <!-- School Header -->
  <div class="school-header">
    <div class="school-logo" onclick="document.getElementById('logoInput').click()">Upload Logo</div>
    <input type="file" id="logoInput" style="display:none" accept="image/*" onchange="previewLogo(event)">
    <div class="school-info">
      <h1 contenteditable="true" id="schoolName">ROYAL WUNDERKIND MODEL SCHOOL</h1>
      <p contenteditable="true" id="schoolMotto">Partnering with Christ for a better world</p>
      <div class="contact-line"><i class="fas fa-map-marker-alt"></i> <span contenteditable="true" id="schoolAddress">Opposite Block 8, Plot 12, Mal. Abdulrahman A, Aderinoye Street</span></div>
      <div class="contact-line"><i class="fas fa-phone"></i> <span contenteditable="true" id="schoolPhone">+2348022738352</span></div>
      <div class="contact-line"><i class="fas fa-envelope"></i> <span contenteditable="true" id="schoolEmail">info@royalwunderkind.edu.ng</span></div>
      <div class="contact-line"><i class="fas fa-globe"></i> <span contenteditable="true" id="schoolWebsite">www.royalwunderkind.edu.ng</span></div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="active" onclick="showTab(event,'result')">Student Result</button>
    <button onclick="showTab(event,'receipt')">School Fees Receipt</button>
  </div>

  <!-- RESULT TAB -->
  <div id="result" class="tab-content active">
    <div class="controls">
      <input type="text" id="studentID" placeholder="Student ID (e.g. RW001)" style="width:200px;">
      <button onclick="saveStudentResult()" class="save-btn">üíæ Save & New</button>
      <button onclick="loadStudentResult()" class="load-btn">üìÇ Load Result</button>
      <select id="termSelect" style="padding:8px;">
        <option>1st Term</option><option>2nd Term</option><option>3rd Term</option>
      </select>
      <button onclick="window.print()" class="print-btn">üñ®Ô∏è Print Result</button>
    </div>
    <div class="info-grid">
      <div><label>Name<input id="resultName"></label></div>
      <div><label>Admission No<input id="resultAdmNo"></label></div>
      <div><label>Class<input id="resultClass"></label></div>
      <div><label>No. in Class<input id="resultNoInClass"></label></div>
      <div><label>Times Present<input id="resultPresent"></label></div>
      <div><label>Times Absent<input id="resultAbsent"></label></div>
    </div>
    <div class="table-wrapper">
      <table id="resultTable">
        <thead>
          <tr>
            <th>Subject</th>
            <th>CA1 (15)</th>
            <th>CA2 (15)</th>
            <th>HW (10)</th>
            <th>Exam (60)</th>
            <th>Total</th>
            <th>Grade</th>
            <th>Remark</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr style="font-weight:bold; background:#f0e6f0;">
            <td>Class Average</td>
            <td id="avgCA1">-</td>
            <td id="avgCA2">-</td>
            <td id="avgHW">-</td>
            <td id="avgExam">-</td>
            <td id="avgTotal">-</td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
      <button onclick="addSubject()" class="small-btn">Add Subject</button>
    </div>
    <div class="two-col">
      <div>
        <div class="section-title">Psychomotor Skills</div>
        <table>
          <tr><td>Handling of Tools</td><td><input id="psycho1"></td></tr>
          <tr><td>Verbal Fluency</td><td><input id="psycho2"></td></tr>
        </table>
      </div>
      <div>
        <div class="section-title">Affective Skills</div>
        <table>
          <tr><td>Cooperation</td><td><input id="affect1"></td></tr>
          <tr><td>Punctuality</td><td><input id="affect2"></td></tr>
          <tr><td>Reading</td><td><input id="affect3"></td></tr>
          <tr><td>Clean & Orderly</td><td><input id="affect4"></td></tr>
        </table>
      </div>
    </div>
    <div class="section-title">Teacher's Comment</div>
    <textarea id="teacherComment"></textarea>
    <div class="footer">
      <div>
        <strong>Class Teacher's Signature</strong>
        <div class="signature-upload" onclick="document.getElementById('classSigInput').click()">
          Click to upload
          <button class="signature-delete" onclick="deleteSignature(event, 'sigClass')">√ó</button>
        </div>
        <input type="file" id="classSigInput" style="display:none" accept="image/*" onchange="previewSignature(event, 'sigClass')">
      </div>
      <div>
        <strong>Head Teacher's Signature</strong>
        <div class="signature-upload" onclick="document.getElementById('headSigInput').click()">
          Click to upload
          <button class="signature-delete" onclick="deleteSignature(event, 'sigHead')">√ó</button>
        </div>
        <input type="file" id="headSigInput" style="display:none" accept="image/*" onchange="previewSignature(event, 'sigHead')">
      </div>
    </div>
  </div>

  <!-- RECEIPT TAB -->
  <div id="receipt" class="tab-content">
    <div class="controls">
      <input type="text" id="receiptID" placeholder="Receipt ID (e.g. REC001)" style="width:200px;">
      <button onclick="saveReceipt()" class="save-btn">üíæ Save & New</button>
      <button onclick="loadReceipt()" class="load-btn">üìÇ Load Receipt</button>
      <button onclick="window.print()" class="print-btn">üñ®Ô∏è Print Receipt</button>
      <button onclick="exportReceipt()" class="small-btn">Export Excel</button>
      <button onclick="requestAdminAccess()" class="small-btn" id="adminBtn">Admin Mode</button>
    </div>
    <div class="info-grid">
      <div><label>Student Name<input id="receiptName" disabled></label></div>
      <div><label>Class<input id="receiptClass" disabled></label></div>
      <div><label>Term<select id="receiptTerm" disabled><option>1st Term</option><option>2nd Term</option><option>3rd Term</option></select></label></div>
      <div><label>Session<input id="receiptSession" disabled></label></div>
      <div><label>Date<input type="date" id="receiptDate" disabled></label></div>
    </div>
    <div class="table-wrapper">
      <table id="receiptTable">
        <thead>
          <tr>
            <th>Description</th>
            <th>Amount (‚Ç¶)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button onclick="addReceiptRow()" class="small-btn" id="addEntryBtn" disabled>Add Entry</button>
    <div class="total-box">TOTAL: ‚Ç¶ <input id="totalReceipt" readonly style="width:150px; text-align:right; font-weight:bold;"></div>
    <div class="footer">
      <div>
        <strong>Finance Officer</strong>
        <div class="signature-upload" onclick="document.getElementById('financeInput').click()">
          Click to upload
          <button class="signature-delete" onclick="deleteSignature(event, 'sigFinance')">√ó</button>
        </div>
        <input type="file" id="financeInput" style="display:none" accept="image/*" onchange="previewSignature(event, 'sigFinance')" disabled>
      </div>
      <div>
        <strong>School Stamp</strong>
        <div class="signature-upload" onclick="document.getElementById('stampInput').click()">
          Click to upload
          <button class="signature-delete" onclick="deleteSignature(event, 'sigStamp')">√ó</button>
        </div>
        <input type="file" id="stampInput" style="display:none" accept="image/*" onchange="previewSignature(event, 'sigStamp')" disabled>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal">
  <div class="modal-content">
    <h3>GitHub Settings</h3>
    <p>To save/load results & receipts from anywhere, enter a GitHub Personal Access Token (with <strong>gist</strong> scope):</p>
    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxx" style="width:100%; padding:8px;">
    <div style="margin-top:10px;">
      <button onclick="saveGitHubToken()" style="background:#28a745;">Save Token</button>
      <button onclick="closeSettings()" style="background:#dc3545; margin-left:10px;">Cancel</button>
    </div>
    <p style="font-size:12px; margin-top:15px;">
      <a href="https://github.com/settings/tokens/new" target="_blank">Create token here</a> ‚Üí select "gist" scope only.
    </p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// GitHub Gist storage
const GIST_ID_RESULTS = 'results_storage'; // one gist for all results
const GIST_ID_RECEIPTS = 'receipts_storage'; // one gist for all receipts
let githubToken = localStorage.getItem('githubToken') || '';

// Settings modal
function openSettings() {
  document.getElementById('githubToken').value = githubToken ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
  document.getElementById('settingsModal').style.display = 'flex';
}
function closeSettings() {
  document.getElementById('settingsModal').style.display = 'none';
}
function saveGitHubToken() {
  const token = document.getElementById('githubToken').value.trim();
  if (token && token !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
    githubToken = token;
    localStorage.setItem('githubToken', token);
    alert('GitHub token saved!');
  }
  closeSettings();
}

// Gist helpers
async function getGist(id) {
  if (!githubToken) { alert('Please set GitHub token in Settings first!'); return null; }
  const res = await fetch(`https://api.github.com/gists/${id}`, {
    headers: { Authorization: `token ${githubToken}` }
  });
  if (res.status === 404) return null;
  if (!res.ok) { alert('GitHub error: ' + await res.text()); return null; }
  return await res.json();
}
async function createOrUpdateGist(id, description, files) {
  if (!githubToken) { alert('Please set GitHub token in Settings first!'); return null; }
  const existing = await getGist(id);
  const method = existing ? 'PATCH' : 'POST';
  const url = existing ? `https://api.github.com/gists/${id}` : 'https://api.github.com/gists';
  const body = {
    description,
    public: false,
    files
  };
  if (existing) body.gist_id = id;
  const res = await fetch(url, {
    method,
    headers: { Authorization: `token ${githubToken}`, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) { alert('GitHub save error: ' + await res.text()); return null; }
  const data = await res.json();
  return data.id;
}

// Load all saved results/receipts index
async function loadAllResults() {
  const gist = await getGist(GIST_ID_RESULTS);
  if (!gist || !gist.files['index.json']) return {};
  return JSON.parse(gist.files['index.json'].content);
}
async function loadAllReceipts() {
  const gist = await getGist(GIST_ID_RECEIPTS);
  if (!gist || !gist.files['index.json']) return {};
  return JSON.parse(gist.files['index.json'].content);
}

// Save individual result/receipt
async function saveToGist(collectionId, indexKey, data) {
  const index = await (collectionId === GIST_ID_RESULTS ? loadAllResults() : loadAllReceipts());
  index[indexKey] = data;
  const files = {
    'index.json': { content: JSON.stringify(index) }
  };
  await createOrUpdateGist(collectionId, 'School results/receipts storage', files);
}

// Load individual
async function loadFromGist(collectionId, key) {
  const index = await (collectionId === GIST_ID_RESULTS ? loadAllResults() : loadAllReceipts());
  return index[key] || null;
}

// School header & images (still localStorage ‚Äì small data)
const STORAGE_KEY_LOGO = 'schoolLogo';
const STORAGE_KEY_SIG_CLASS = 'sigClass';
const STORAGE_KEY_SIG_HEAD = 'sigHead';
const STORAGE_KEY_SIG_FINANCE = 'sigFinance';
const STORAGE_KEY_SIG_STAMP = 'sigStamp';
const STORAGE_KEY_SCHOOL_INFO = 'schoolHeaderInfo';

function saveSchoolHeader() {
  const info = {
    name: document.getElementById('schoolName').innerText.trim(),
    motto: document.getElementById('schoolMotto').innerText.trim(),
    address: document.getElementById('schoolAddress').innerText.trim(),
    phone: document.getElementById('schoolPhone').innerText.trim(),
    email: document.getElementById('schoolEmail').innerText.trim(),
    website: document.getElementById('schoolWebsite').innerText.trim()
  };
  localStorage.setItem(STORAGE_KEY_SCHOOL_INFO, JSON.stringify(info));
}
function loadSchoolHeader() {
  const saved = localStorage.getItem(STORAGE_KEY_SCHOOL_INFO);
  if (saved) {
    const info = JSON.parse(saved);
    document.getElementById('schoolName').innerText = info.name;
    document.getElementById('schoolMotto').innerText = info.motto;
    document.getElementById('schoolAddress').innerText = info.address;
    document.getElementById('schoolPhone').innerText = info.phone;
    document.getElementById('schoolEmail').innerText = info.email;
    document.getElementById('schoolWebsite').innerText = info.website;
  }
}
['schoolName','schoolMotto','schoolAddress','schoolPhone','schoolEmail','schoolWebsite'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('blur', saveSchoolHeader);
});

// Signature functions
function previewSignature(e, key) {
  const file = e.target.files[0];
  if (!file || file.size > 5*1024*1024) { alert("File too large"); return; }
  const reader = new FileReader();
  reader.onload = ev => {
    localStorage.setItem(key, ev.target.result);
    const img = document.createElement('img');
    img.src = ev.target.result;
    const container = e.target.parentElement.querySelector('.signature-upload');
    container.innerHTML = '<button class="signature-delete" onclick="deleteSignature(event, \'' + key + '\')">√ó</button>';
    container.appendChild(img);
  };
  reader.readAsDataURL(file);
}
function deleteSignature(e, key) {
  e.stopPropagation();
  localStorage.removeItem(key);
  const container = e.target.parentElement;
  container.innerHTML = 'Click to upload<button class="signature-delete" style="display:none"></button>';
}
function loadImages() {
  const logo = localStorage.getItem(STORAGE_KEY_LOGO);
  if (logo) {
    const img = document.createElement('img');
    img.src = logo;
    document.querySelector('.school-logo').innerHTML = '';
    document.querySelector('.school-logo').appendChild(img);
  }
  const sigMap = {
    sigClass: 'classSigInput',
    sigHead: 'headSigInput',
    sigFinance: 'financeInput',
    sigStamp: 'stampInput'
  };
  Object.keys(sigMap).forEach(key => {
    const data = localStorage.getItem(key);
    if (data) {
      const img = document.createElement('img');
      img.src = data;
      const container = document.getElementById(sigMap[key]).parentElement.querySelector('.signature-upload');
      container.innerHTML = '<button class="signature-delete" onclick="deleteSignature(event, \'' + key + '\')">√ó</button>';
      container.appendChild(img);
    }
  });
}

// Result functions
function clearResultForm() {
  document.getElementById('resultName').value = '';
  document.getElementById('resultAdmNo').value = '';
  document.getElementById('resultClass').value = '';
  document.getElementById('resultNoInClass').value = '';
  document.getElementById('resultPresent').value = '';
  document.getElementById('resultAbsent').value = '';
  document.getElementById('teacherComment').value = '';
  document.getElementById('psycho1').value = '';
  document.getElementById('psycho2').value = '';
  document.getElementById('affect1').value = '';
  document.getElementById('affect2').value = '';
  document.getElementById('affect3').value = '';
  document.getElementById('affect4').value = '';
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';
  addSubjectRow();
  calculateGrades();
}
async function saveStudentResult() {
  const id = document.getElementById('studentID').value.trim();
  if (!id) { alert("Please enter a Student ID"); return; }
  const data = getCurrentResultData();
  await saveToGist(GIST_ID_RESULTS, id, data);
  alert(`Result saved for ${id}`);
  document.getElementById('studentID').value = '';
  clearResultForm();
}
async function loadStudentResult() {
  const id = document.getElementById('studentID').value.trim();
  if (!id) { alert("Please enter a Student ID"); return; }
  const data = await loadFromGist(GIST_ID_RESULTS, id);
  if (!data) { alert(`No result found for ${id}`); return; }
  loadResultFromData(data);
  calculateClassAverages(); // update averages after load
}

// Receipt functions
function clearReceiptForm() {
  document.getElementById('receiptName').value = '';
  document.getElementById('receiptClass').value = '';
  document.getElementById('receiptSession').value = '';
  document.getElementById('receiptDate').value = '';
  const tbody = document.querySelector('#receiptTable tbody');
  tbody.innerHTML = '';
  addReceiptRowInternal('', '0');
  updateTotal();
}
async function saveReceipt() {
  const id = document.getElementById('receiptID').value.trim();
  if (!id) { alert("Please enter a Receipt ID"); return; }
  const data = getCurrentReceiptData();
  await saveToGist(GIST_ID_RECEIPTS, id, data);
  alert(`Receipt saved as ${id}`);
  document.getElementById('receiptID').value = '';
  clearReceiptForm();
}
async function loadReceipt() {
  const id = document.getElementById('receiptID').value.trim();
  if (!id) { alert("Please enter a Receipt ID"); return; }
  const data = await loadFromGist(GIST_ID_RECEIPTS, id);
  if (!data) { alert(`No receipt found for ${id}`); return; }
  document.getElementById('receiptName').value = data.name || '';
  document.getElementById('receiptClass').value = data.class || '';
  document.getElementById('receiptTerm').value = data.term || '1st Term';
  document.getElementById('receiptSession').value = data.session || '';
  document.getElementById('receiptDate').value = data.date || '';
  const tbody = document.querySelector('#receiptTable tbody');
  tbody.innerHTML = '';
  (data.items || []).forEach(item => addReceiptRowInternal(item.desc, item.amt));
  updateTotal();
}

// Result data
function getCurrentResultData() {
  const data = {
    name: document.getElementById('resultName').value,
    admNo: document.getElementById('resultAdmNo').value,
    class: document.getElementById('resultClass').value,
    noInClass: document.getElementById('resultNoInClass').value,
    present: document.getElementById('resultPresent').value,
    absent: document.getElementById('resultAbsent').value,
    term: document.getElementById('termSelect').value,
    subjects: [],
    psycho: [document.getElementById('psycho1').value, document.getElementById('psycho2').value],
    affect: [document.getElementById('affect1').value, document.getElementById('affect2').value,
             document.getElementById('affect3').value, document.getElementById('affect4').value],
    comment: document.getElementById('teacherComment').value
  };
  document.querySelectorAll('#resultTable tbody tr').forEach(row => {
    const inputs = row.querySelectorAll('input.score');
    data.subjects.push({
      subject: row.cells[0].querySelector('input').value.trim(),
      ca1: inputs[0].value,
      ca2: inputs[1].value,
      hw: inputs[2].value,
      exam: inputs[3].value
    });
  });
  return data;
}
function getCurrentReceiptData() {
  const data = {
    name: document.getElementById('receiptName').value,
    class: document.getElementById('receiptClass').value,
    term: document.getElementById('receiptTerm').value,
    session: document.getElementById('receiptSession').value,
    date: document.getElementById('receiptDate').value,
    items: []
  };
  document.querySelectorAll('#receiptTable tbody tr').forEach(row => {
    const inputs = row.querySelectorAll('input');
    data.items.push({desc: inputs[0].value, amt: inputs[1].value});
  });
  return data;
}
function loadResultFromData(data) {
  document.getElementById('resultName').value = data.name || '';
  document.getElementById('resultAdmNo').value = data.admNo || '';
  document.getElementById('resultClass').value = data.class || '';
  document.getElementById('resultNoInClass').value = data.noInClass || '';
  document.getElementById('resultPresent').value = data.present || '';
  document.getElementById('resultAbsent').value = data.absent || '';
  document.getElementById('termSelect').value = data.term || '1st Term';
  document.getElementById('psycho1').value = data.psycho?.[0] || '';
  document.getElementById('psycho2').value = data.psycho?.[1] || '';
  document.getElementById('affect1').value = data.affect?.[0] || '';
  document.getElementById('affect2').value = data.affect?.[1] || '';
  document.getElementById('affect3').value = data.affect?.[2] || '';
  document.getElementById('affect4').value = data.affect?.[3] || '';
  document.getElementById('teacherComment').value = data.comment || '';
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';
  (data.subjects || []).forEach(sub => {
    addSubjectRow(sub.subject, sub.ca1, sub.ca2, sub.hw, sub.exam);
  });
  if ((data.subjects || []).length === 0) addSubjectRow();
  calculateGrades();
}

// Subject rows
function addSubjectRow(subject='', ca1='', ca2='', hw='', exam='') {
  const tbody = document.getElementById('resultTable').querySelector('tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input value="${subject}"></td>
    <td><input class="score" value="${ca1}"></td>
    <td><input class="score" value="${ca2}"></td>
    <td><input class="score" value="${hw}"></td>
    <td><input class="score" value="${exam}"></td>
    <td><input class="total" readonly></td>
    <td><select class="grade" readonly>
      <option>A+</option><option>A</option><option>B+</option><option>B</option>
      <option>C+</option><option>C</option><option>D</option><option>F</option>
    </select></td>
    <td><select class="remark">
      <option>Outstanding</option><option>Excellent</option><option>Very Good</option>
      <option>Good</option><option>Average</option><option>Fair</option><option>Fail</option>
    </select></td>
    <td><button onclick="removeSubject(this)" class="small-btn">Remove</button></td>
  `;
  tbody.appendChild(tr);
  tr.querySelectorAll('.score').forEach(inp => inp.addEventListener('input', () => { calculateGrades(); calculateClassAverages(); }));
}
function addSubject() { addSubjectRow(); }
function removeSubject(btn) {
  btn.closest('tr').remove();
  calculateGrades();
  calculateClassAverages();
}
function calculateGrades() {
  document.querySelectorAll('#resultTable tbody tr').forEach(row => {
    const scores = row.querySelectorAll('.score');
    let total = 0;
    scores.forEach(s => total += Number(s.value) || 0);
    row.querySelector('.total').value = total;
    const grade = getGrade(total);
    row.querySelector('.grade').value = grade;
    const remark = getRemark(total);
    row.querySelector('.remark').value = remark;
  });
}
function getGrade(score) {
  if (score >= 95) return 'A+';
  if (score >= 90) return 'A';
  if (score >= 85) return 'B+';
  if (score >= 75) return 'B';
  if (score >= 70) return 'C+';
  if (score >= 60) return 'C';
  if (score >= 50) return 'D';
  return 'F';
}
function getRemark(score) {
  if (score >= 95) return 'Outstanding';
  if (score >= 90) return 'Excellent';
  if (score >= 85) return 'Very Good';
  if (score >= 75) return 'Good';
  if (score >= 60) return 'Average';
  if (score >= 50) return 'Fair';
  return 'Fail';
}

// Class averages
async function calculateClassAverages() {
  const currentClass = document.getElementById('resultClass').value.trim();
  const currentTerm = document.getElementById('termSelect').value;
  if (!currentClass || !currentTerm) {
    clearAverages();
    return;
  }
  const allResults = await loadAllResults();
  const relevant = Object.values(allResults).filter(r => r.class === currentClass && r.term === currentTerm);
  if (relevant.length === 0) {
    clearAverages();
    return;
  }

  // Build map of subject ‚Üí arrays of scores
  const subjectMap = {};
  relevant.forEach(result => {
    result.subjects.forEach(sub => {
      const name = sub.subject.toUpperCase();
      if (!subjectMap[name]) subjectMap[name] = {ca1:[], ca2:[], hw:[], exam:[], total:[]};
      subjectMap[name].ca1.push(Number(sub.ca1)||0);
      subjectMap[name].ca2.push(Number(sub.ca2)||0);
      subjectMap[name].hw.push(Number(sub.hw)||0);
      subjectMap[name].exam.push(Number(sub.exam)||0);
      const tot = (Number(sub.ca1)||0) + (Number(sub.ca2)||0) + (Number(sub.hw)||0) + (Number(sub.exam)||0);
      subjectMap[name].total.push(tot);
    });
  });

  // Compute averages per current subject order
  const rows = document.querySelectorAll('#resultTable tbody tr');
  rows.forEach((row, idx) => {
    const subj = row.cells[0].querySelector('input').value.trim().toUpperCase();
    if (subjectMap[subj]) {
      const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : '-';
      document.getElementById('avgCA1').parentElement.parentElement.children[idx+1].querySelectorAll('td')[1].innerText = avg(subjectMap[subj].ca1);
      // Note: we only update the cells that exist ‚Äì simple approach
    }
  });

  // Simple overall averages (shown only if subjects match)
  const allCA1 = [], allCA2 = [], allHW = [], allExam = [], allTotal = [];
  rows.forEach(row => {
    const subj = row.cells[0].querySelector('input').value.trim().toUpperCase();
    if (subjectMap[subj]) {
      const avgObj = subjectMap[subj];
      allCA1.push(...avgObj.ca1);
      allCA2.push(...avgObj.ca2);
      allHW.push(...avgObj.hw);
      allExam.push(...avgObj.exam);
      allTotal.push(...avgObj.total);
    }
  });
  const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : '-';
  document.getElementById('avgCA1').innerText = avg(allCA1);
  document.getElementById('avgCA2').innerText = avg(allCA2);
  document.getElementById('avgHW').innerText = avg(allHW);
  document.getElementById('avgExam').innerText = avg(allExam);
  document.getElementById('avgTotal').innerText = avg(allTotal);
}
function clearAverages() {
  document.getElementById('avgCA1').innerText = '-';
  document.getElementById('avgCA2').innerText = '-';
  document.getElementById('avgHW').innerText = '-';
  document.getElementById('avgExam').innerText = '-';
  document.getElementById('avgTotal').innerText = '-';
}

// Receipt rows
function addReceiptRowInternal(desc='', amt='0') {
  const tbody = document.getElementById('receiptTable').querySelector('tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input value="${desc}"></td>
    <td><input class="amt" type="number" value="${amt}" oninput="updateTotal()"></td>
    <td><button onclick="removeReceiptRow(this)" class="small-btn">Remove</button></td>
  `;
  tbody.appendChild(tr);
}
function addReceiptRow() {
  if (!adminEnabled) return;
  addReceiptRowInternal();
}
function removeReceiptRow(btn) {
  btn.closest('tr').remove();
  updateTotal();
}
function updateTotal() {
  let total = 0;
  document.querySelectorAll('#receiptTable .amt').forEach(inp => total += Number(inp.value) || 0);
  document.getElementById('totalReceipt').value = total.toLocaleString();
}
function exportReceipt() {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(document.getElementById('receiptTable'));
  XLSX.utils.book_append_sheet(wb, ws, "Receipt");
  XLSX.writeFile(wb, "School_Receipt.xlsx");
}

// Admin mode (unchanged except idle timer touches mobile)
let adminEnabled = false;
let idleTimer = null;
const IDLE_TIMEOUT = 30 * 60 * 1000;
function requestAdminAccess() {
  const password = prompt("Enter Admin Password:");
  if (password === 'admin123') enableAdminMode();
  else alert("Incorrect password.");
}
function enableAdminMode() {
  adminEnabled = true;
  document.querySelectorAll('#receipt input, #receipt select, #receipt button:not(#adminBtn), #receipt .signature-upload input[type=file]').forEach(el => el.disabled = false);
  document.getElementById('addEntryBtn').disabled = false;
  alert("Admin mode enabled.");
  resetIdleTimer();
  document.addEventListener('mousemove', resetIdleTimer);
  document.addEventListener('keydown', resetIdleTimer);
  document.addEventListener('touchstart', resetIdleTimer);
}
function resetIdleTimer() {
  if (idleTimer) clearTimeout(idleTimer);
  if (adminEnabled) {
    idleTimer = setTimeout(() => {
      adminEnabled = false;
      document.querySelectorAll('#receipt input, #receipt select, #receipt button:not(#adminBtn), #receipt .signature-upload input[type=file]').forEach(el => el.disabled = true);
      document.getElementById('addEntryBtn').disabled = true;
      alert("Admin mode disabled due to inactivity.");
    }, IDLE_TIMEOUT);
  }
}

// Logo
function previewLogo(e) {
  const file = e.target.files[0];
  if (!file || file.size > 5*1024*1024) { alert("File too large"); return; }
  const reader = new FileReader();
  reader.onload = ev => {
    localStorage.setItem(STORAGE_KEY_LOGO, ev.target.result);
    const img = document.createElement('img');
    img.src = ev.target.result;
    document.querySelector('.school-logo').innerHTML = '';
    document.querySelector('.school-logo').appendChild(img);
  };
  reader.readAsDataURL(file);
}

// Tab switching
function showTab(event, id) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.currentTarget.classList.add('active');
  if (id === 'result') calculateClassAverages();
}

// Init
loadImages();
loadSchoolHeader();
addSubjectRow();
addReceiptRowInternal('', '0');
calculateGrades();
updateTotal();
if (githubToken) alert('GitHub token loaded ‚Äì you can now save/load from anywhere!');
else openSettings(); // prompt first time
</script>
</body>
</html>
